<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í‰ê°€ ìˆ˜í–‰ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ì‹œìŠ¤í…œ</h1>
      <div class="user-info">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div style="margin-bottom:16px;">
      <a href="dashboard.html" class="btn btn-secondary btn-sm">&larr; ëŒ€ì‹œë³´ë“œë¡œ</a>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span>í‰ê°€ ëŒ€ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>

    <div id="alert-area"></div>
    <div id="criteria-area"></div>
    <div id="eval-area"></div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    if (!Auth.requireStudent()) throw new Error('Redirect');

    document.getElementById('user-name').textContent = Auth.getUserName() + ' (' + Auth.getStudentId() + ')';

    const params = new URLSearchParams(window.location.search);
    const assignmentId = params.get('id');

    if (!assignmentId) {
      window.location.href = 'dashboard.html';
    }

    let targets = [];
    let minScore = 0, maxScore = 100;

    async function loadTargets() {
      const loading = document.getElementById('loading');
      try {
        const r = await API.getEvaluationTargets(Auth.getStudentId(), Auth.getPassword(), assignmentId, Auth.getCourseId());
        loading.style.display = 'none';

        if (!r.success) {
          document.getElementById('alert-area').innerHTML = `<div class="alert alert-error">${r.error}</div>`;
          return;
        }

        targets = r.targets;
        minScore = r.minScore || 0;
        maxScore = r.maxScore || 100;

        // ì±„ì  ê¸°ì¤€ í‘œì‹œ
        if (r.criteria) {
          document.getElementById('criteria-area').innerHTML = `
            <div class="card">
              <div class="card-title">ì±„ì  ê¸°ì¤€</div>
              <p style="font-size:0.9rem;line-height:1.8;white-space:pre-wrap;">${escapeHtml(r.criteria)}</p>
              <p style="font-size:0.8125rem;color:var(--gray-500);margin-top:8px;">ì ìˆ˜ ë²”ìœ„: ${minScore} ~ ${maxScore}ì  (ì •ìˆ˜ë§Œ ì…ë ¥)</p>
            </div>
          `;
        }

        renderTargets();
      } catch (err) {
        loading.style.display = 'none';
        document.getElementById('alert-area').innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    function renderTargets() {
      let html = '';
      targets.forEach((t, idx) => {
        const isCompleted = t.score !== null;
        html += `
          <div class="eval-target" id="target-${idx}">
            <div class="target-header">
              <span class="target-name">í‰ê°€ ëŒ€ìƒ ${idx + 1}: ${escapeHtml(t.targetName)}</span>
              ${isCompleted ? '<span class="badge badge-finalized">í‰ê°€ ì™„ë£Œ</span>' : '<span class="badge badge-evaluating">ë¯¸ì™„ë£Œ</span>'}
            </div>
            <p style="margin-bottom:12px;">
              <a href="${escapeHtml(t.submissionLink)}" target="_blank" class="submission-link">ğŸ“ ê³¼ì œë¬¼ ë³´ê¸° (ìƒˆ íƒ­)</a>
            </p>

            <div class="form-group">
              <label>ì ìˆ˜ (${minScore}~${maxScore})</label>
              <input type="number" id="score-${idx}" min="${minScore}" max="${maxScore}" step="1"
                     value="${isCompleted ? t.score : ''}" placeholder="${minScore}~${maxScore} ì‚¬ì´ ì •ìˆ˜">
            </div>

            <div class="form-group">
              <label>ì„œìˆ í‰ (ìµœì†Œ 20ì)</label>
              <textarea id="comment-${idx}" placeholder="í‰ê°€ ì˜ê²¬ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                        oninput="updateCharCount(${idx})">${isCompleted ? escapeHtml(t.comment || '') : ''}</textarea>
              <div class="char-count" id="char-count-${idx}">0ì / ìµœì†Œ 20ì</div>
            </div>

            <button class="btn btn-primary" onclick="submitEval(${idx})" id="btn-submit-${idx}">
              ${isCompleted ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì¶œí•˜ê¸°'}
            </button>
          </div>
        `;
      });
      document.getElementById('eval-area').innerHTML = html;

      // ì´ˆê¸° ê¸€ììˆ˜ ì—…ë°ì´íŠ¸
      targets.forEach((_, idx) => updateCharCount(idx));
    }

    function updateCharCount(idx) {
      const textarea = document.getElementById('comment-' + idx);
      const counter = document.getElementById('char-count-' + idx);
      const len = textarea.value.length;
      counter.textContent = len + 'ì / ìµœì†Œ 20ì';
      counter.className = 'char-count' + (len < 20 ? ' warn' : '');
    }

    async function submitEval(idx) {
      const target = targets[idx];
      const scoreInput = document.getElementById('score-' + idx);
      const commentInput = document.getElementById('comment-' + idx);
      const score = scoreInput.value;
      const comment = commentInput.value;

      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬
      if (score === '') { alert('ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const numScore = Number(score);
      if (!Number.isInteger(numScore) || numScore < minScore || numScore > maxScore) {
        alert(`ì ìˆ˜ëŠ” ${minScore}~${maxScore} ì‚¬ì´ì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
        return;
      }
      if (comment.trim().length < 20) {
        alert('ì„œìˆ í‰ì€ ìµœì†Œ 20ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const btn = document.getElementById('btn-submit-' + idx);
      btn.disabled = true;
      btn.textContent = 'ì œì¶œ ì¤‘...';

      try {
        const r = await API.submitEvaluation(
          Auth.getStudentId(), Auth.getPassword(),
          assignmentId, target.targetStudentId, numScore, comment.trim(),
          Auth.getCourseId()
        );

        if (!r.success) {
          alert('ì˜¤ë¥˜: ' + r.error);
          btn.disabled = false;
          btn.textContent = 'ì œì¶œí•˜ê¸°';
          return;
        }

        // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
        targets[idx].score = numScore;
        targets[idx].comment = comment.trim();
        renderTargets();

        // ëª¨ë‘ ì™„ë£Œ í™•ì¸
        const allDone = targets.every(t => t.score !== null);
        if (allDone) {
          document.getElementById('alert-area').innerHTML =
            '<div class="alert alert-success">ëª¨ë“  í‰ê°€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ë§ˆê° ì „ê¹Œì§€ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        } else {
          document.getElementById('alert-area').innerHTML =
            '<div class="alert alert-success">í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        }
      } catch (err) {
        alert('ì„œë²„ ì˜¤ë¥˜: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'ì œì¶œí•˜ê¸°';
      }
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    loadTargets();
  </script>
</body>
</html>
