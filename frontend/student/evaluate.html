<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>í‰ê°€ ìˆ˜í–‰ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css?v=20260216d">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ì‹œìŠ¤í…œ</h1>
      <div class="user-info">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div style="margin-bottom:16px;">
      <a href="dashboard.html" class="btn btn-secondary btn-sm">&larr; ëŒ€ì‹œë³´ë“œë¡œ</a>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span>í‰ê°€ ëŒ€ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>

    <div id="alert-area"></div>
    <div id="criteria-area"></div>
    <div id="eval-area"></div>
  </div>

  <script src="../js/api.js?v=20260216d"></script>
  <script src="../js/auth.js?v=20260216d"></script>
  <script>
    if (!Auth.requireStudent()) throw new Error('Redirect');

    document.getElementById('user-name').textContent = Auth.getUserName() + ' (' + Auth.getStudentId() + ')';

    const params = new URLSearchParams(window.location.search);
    const assignmentId = params.get('id');

    if (!assignmentId) {
      window.location.href = 'dashboard.html';
    }

    let targets = [];
    let minScore = 0, maxScore = 100;

    async function loadTargets() {
      const loading = document.getElementById('loading');
      try {
        const r = await API.getEvaluationTargets(Auth.getStudentId(), Auth.getPassword(), assignmentId, Auth.getCourseId());
        loading.style.display = 'none';

        if (!r.success) {
          document.getElementById('alert-area').innerHTML = `<div class="alert alert-error">${r.error}</div>`;
          return;
        }

        targets = r.targets;
        minScore = r.minScore || 0;
        maxScore = r.maxScore || 100;

        // ì±„ì  ê¸°ì¤€ í‘œì‹œ
        if (r.criteria) {
          document.getElementById('criteria-area').innerHTML = `
            <div class="card">
              <div class="card-title">ì±„ì  ê¸°ì¤€</div>
              <p style="font-size:0.9rem;line-height:1.8;white-space:pre-wrap;">${escapeHtml(r.criteria)}</p>
              <p style="font-size:0.8125rem;color:var(--gray-500);margin-top:8px;">ì ìˆ˜ ë²”ìœ„: ${minScore} ~ ${maxScore}ì  (ì •ìˆ˜ë§Œ ì…ë ¥)</p>
            </div>
          `;
        }

        renderTargets();
      } catch (err) {
        loading.style.display = 'none';
        document.getElementById('alert-area').innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    function renderTargets() {
      let html = '';
      targets.forEach((t, idx) => {
        const isCompleted = t.score !== null && t.score !== undefined;
        // ë¸”ë¼ì¸ë“œ: targetLabel ("í•™ìƒ 1", "í•™ìƒ 2") ì‚¬ìš©, í•™ë²ˆ/ì´ë¦„ ì ˆëŒ€ ë…¸ì¶œ ì•ˆ í•¨
        const label = t.targetLabel || ('í•™ìƒ ' + (idx + 1));

        html += `<div class="eval-target" id="target-${idx}">`;
        html += `  <div class="target-header">`;
        html += `    <span class="target-name">í‰ê°€ ëŒ€ìƒ ${idx + 1}: ${escapeHtml(label)}</span>`;
        html += `    ${isCompleted ? '<span class="badge badge-finalized">í‰ê°€ ì™„ë£Œ</span>' : '<span class="badge badge-evaluating">ë¯¸ì™„ë£Œ</span>'}`;
        html += `  </div>`;
        html += `  <p style="margin-bottom:12px;">`;
        html += `    <a href="${escapeHtml(t.submissionLink)}" target="_blank" class="submission-link">ğŸ“ ê³¼ì œë¬¼ ë³´ê¸° (ìƒˆ íƒ­)</a>`;
        html += `  </p>`;

        if (isCompleted) {
          // ì™„ë£Œ ìƒíƒœ: ê¸°ì¡´ ì ìˆ˜/ì„œìˆ í‰ ìš”ì•½ + [í‰ê°€ ìˆ˜ì •] ë²„íŠ¼
          html += `<div id="eval-summary-${idx}" style="background:var(--gray-50);border-radius:8px;padding:12px;margin-bottom:8px;">`;
          html += `  <div style="font-size:0.875rem;"><strong>ì ìˆ˜:</strong> ${t.score}ì  &nbsp; <strong>ì„œìˆ í‰:</strong> ${escapeHtml(t.comment || '').substring(0, 50)}${(t.comment || '').length > 50 ? '...' : ''}</div>`;
          html += `</div>`;
          html += `<button class="btn btn-secondary btn-sm" onclick="showEditForm(${idx})" id="btn-edit-${idx}">í‰ê°€ ìˆ˜ì •</button>`;
          // ìˆ¨ê²¨ì§„ ìˆ˜ì • í¼
          html += `<div id="eval-form-${idx}" style="display:none;margin-top:12px;">`;
          html += renderEvalForm(idx, t.score, t.comment || '');
          html += `</div>`;
        } else {
          // ë¯¸ì™„ë£Œ ìƒíƒœ: ë°”ë¡œ í¼ í‘œì‹œ
          html += `<div id="eval-form-${idx}">`;
          html += renderEvalForm(idx, '', '');
          html += `</div>`;
        }

        html += `</div>`;
      });

      // ì „ì²´ ì™„ë£Œ ì—¬ë¶€ ì•ˆë‚´
      const allDone = targets.every(t => t.score !== null && t.score !== undefined);
      if (allDone) {
        html = `<div class="alert alert-success" style="margin-bottom:16px;">ëª¨ë“  í‰ê°€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! í‰ê°€ ë§ˆê° ì „ê¹Œì§€ [í‰ê°€ ìˆ˜ì •] ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>` + html;
      }

      document.getElementById('eval-area').innerHTML = html;

      // ì´ˆê¸° ê¸€ììˆ˜ ì—…ë°ì´íŠ¸
      targets.forEach((_, idx) => {
        const textarea = document.getElementById('comment-' + idx);
        if (textarea) updateCharCount(idx);
      });
    }

    function renderEvalForm(idx, scoreVal, commentVal) {
      const isEdit = scoreVal !== '' && scoreVal !== null && scoreVal !== undefined;
      let html = '';
      html += `<div class="form-group">`;
      html += `  <label>ì ìˆ˜ (${minScore}~${maxScore})</label>`;
      html += `  <input type="number" id="score-${idx}" min="${minScore}" max="${maxScore}" step="1"`;
      html += `         value="${isEdit ? scoreVal : ''}" placeholder="${minScore}~${maxScore} ì‚¬ì´ ì •ìˆ˜">`;
      html += `</div>`;
      html += `<div class="form-group">`;
      html += `  <label>ì„œìˆ í‰ (ìµœì†Œ 20ì)</label>`;
      html += `  <textarea id="comment-${idx}" placeholder="í‰ê°€ ì˜ê²¬ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”..."`;
      html += `            oninput="updateCharCount(${idx})">${escapeHtml(commentVal)}</textarea>`;
      html += `  <div class="char-count" id="char-count-${idx}">0ì / ìµœì†Œ 20ì</div>`;
      html += `</div>`;
      html += `<button class="btn btn-primary" onclick="submitEval(${idx})" id="btn-submit-${idx}">`;
      html += isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì¶œí•˜ê¸°';
      html += `</button>`;
      html += `<span id="submit-status-${idx}" style="margin-left:8px;font-size:0.8125rem;"></span>`;
      return html;
    }

    function showEditForm(idx) {
      const summary = document.getElementById('eval-summary-' + idx);
      const editBtn = document.getElementById('btn-edit-' + idx);
      const form = document.getElementById('eval-form-' + idx);
      if (summary) summary.style.display = 'none';
      if (editBtn) editBtn.style.display = 'none';
      if (form) form.style.display = '';
      // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸
      updateCharCount(idx);
    }

    function updateCharCount(idx) {
      const textarea = document.getElementById('comment-' + idx);
      const counter = document.getElementById('char-count-' + idx);
      if (!textarea || !counter) return;
      const len = textarea.value.length;
      counter.textContent = len + 'ì / ìµœì†Œ 20ì';
      counter.className = 'char-count' + (len < 20 ? ' warn' : '');
    }

    async function submitEval(idx) {
      const target = targets[idx];
      const scoreInput = document.getElementById('score-' + idx);
      const commentInput = document.getElementById('comment-' + idx);
      const score = scoreInput.value;
      const comment = commentInput.value;

      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬
      if (score === '') { alert('ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const numScore = Number(score);
      if (!Number.isInteger(numScore) || numScore < minScore || numScore > maxScore) {
        alert(`ì ìˆ˜ëŠ” ${minScore}~${maxScore} ì‚¬ì´ì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
        return;
      }
      if (comment.trim().length < 20) {
        alert('ì„œìˆ í‰ì€ ìµœì†Œ 20ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const btn = document.getElementById('btn-submit-' + idx);
      btn.disabled = true;
      btn.textContent = 'ì œì¶œ ì¤‘...';

      try {
        // ë¸”ë¼ì¸ë“œ: targetIndexë¥¼ ì „ì†¡ (í•™ë²ˆ ëŒ€ì‹ )
        const r = await API.submitEvaluation(
          Auth.getStudentId(), Auth.getPassword(),
          assignmentId, target.targetIndex, numScore, comment.trim(),
          Auth.getCourseId()
        );

        if (!r.success) {
          alert('ì˜¤ë¥˜: ' + r.error);
          btn.disabled = false;
          btn.textContent = target.score !== null ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì¶œí•˜ê¸°';
          return;
        }

        // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
        targets[idx].score = numScore;
        targets[idx].comment = comment.trim();
        renderTargets();

        document.getElementById('alert-area').innerHTML =
          '<div class="alert alert-success">í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
      } catch (err) {
        alert('ì„œë²„ ì˜¤ë¥˜: ' + err.message);
        btn.disabled = false;
        btn.textContent = target.score !== null ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì¶œí•˜ê¸°';
      }
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    loadTargets();
  </script>
</body>
</html>
