<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ê²°ê³¼ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ì‹œìŠ¤í…œ</h1>
      <div class="user-info">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div style="margin-bottom:16px;">
      <a href="dashboard.html" class="btn btn-secondary btn-sm">&larr; ëŒ€ì‹œë³´ë“œë¡œ</a>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>
    <div id="content"></div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    if (!Auth.requireStudent()) throw new Error('Redirect');
    document.getElementById('user-name').textContent = Auth.getUserName() + ' (' + Auth.getStudentId() + ')';

    const params = new URLSearchParams(window.location.search);
    const assignmentId = params.get('id');

    async function loadResults() {
      const loading = document.getElementById('loading');
      const content = document.getElementById('content');

      try {
        const r = await API.getMyResults(Auth.getStudentId(), Auth.getPassword(), Auth.getCourseId());
        loading.style.display = 'none';

        if (!r.success) {
          content.innerHTML = `<div class="alert alert-error">${r.error}</div>`;
          return;
        }

        // íŠ¹ì • ê³¼ì œ í•„í„° ë˜ëŠ” ì „ì²´
        let results = r.results;
        if (assignmentId) {
          results = results.filter(res => res.assignmentId === assignmentId);
        }

        if (results.length === 0) {
          content.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>í™•ì •ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          return;
        }

        let html = '';
        results.forEach(res => {
          const avgScore = res.receivedScores.length > 0
            ? (res.receivedScores.reduce((s, e) => s + Number(e.score), 0) / res.receivedScores.length).toFixed(1)
            : '-';

          html += `<div class="card">
            <div class="card-title">${escapeHtml(res.assignmentName)}</div>

            <div class="grid-3" style="margin-bottom:20px;">
              <div class="stat-card">
                <div class="stat-value">${avgScore}</div>
                <div class="stat-label">ìƒí˜¸í‰ê°€ í‰ê· </div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${res.professorScore !== null ? res.professorScore : '-'}</div>
                <div class="stat-label">êµìˆ˜ í‰ê°€</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${res.receivedScores.length}</div>
                <div class="stat-label">í‰ê°€ ë°›ì€ ìˆ˜</div>
              </div>
            </div>

            <h4 style="font-size:0.9rem;color:var(--gray-600);margin-bottom:12px;">ìƒí˜¸í‰ê°€ ìƒì„¸</h4>
          `;

          res.receivedScores.forEach((ev, idx) => {
            html += `
              <div class="result-item">
                <div class="score-label">ìµëª… í‰ê°€ì ${idx + 1}</div>
                <div class="score-value">${ev.score}ì </div>
                <div class="comment-text">${escapeHtml(ev.comment)}</div>
              </div>
            `;
          });

          if (res.professorScore !== null) {
            html += `
              <h4 style="font-size:0.9rem;color:var(--gray-600);margin:16px 0 12px;">êµìˆ˜ í‰ê°€</h4>
              <div class="result-item professor-eval">
                <div class="score-label">êµìˆ˜</div>
                <div class="score-value">${res.professorScore}ì </div>
                <div class="comment-text">${escapeHtml(res.professorComment || '')}</div>
              </div>
            `;
          }

          html += '</div>';
        });
        content.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        content.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    loadResults();
  </script>
</body>
</html>
