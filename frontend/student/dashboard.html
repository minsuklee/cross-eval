<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css?v=20260216b">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ì‹œìŠ¤í…œ</h1>
      <div class="user-info">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('assignments')">ê³¼ì œ ëª©ë¡</button>
      <button class="nav-tab" onclick="showSection('results')">ë‚´ ê²°ê³¼</button>
    </div>

    <div id="alert-area"></div>

    <div id="section-assignments">
      <div id="assignments-loading" class="loading">
        <div class="spinner"></div>
        <span>ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div id="assignments-list"></div>
    </div>

    <div id="section-results" style="display:none;">
      <div id="results-loading" class="loading">
        <div class="spinner"></div>
        <span>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div id="results-list"></div>
    </div>
  </div>

  <script src="../js/api.js?v=20260216b"></script>
  <script src="../js/auth.js?v=20260216b"></script>
  <script>
    if (!Auth.requireStudent()) throw new Error('Redirect');

    document.getElementById('user-name').textContent = Auth.getUserName() + ' (' + Auth.getStudentId() + ')';

    function showSection(name) {
      document.querySelectorAll('.nav-tab').forEach((t, i) => {
        t.classList.toggle('active', (name === 'assignments' && i === 0) || (name === 'results' && i === 1));
      });
      document.getElementById('section-assignments').style.display = name === 'assignments' ? '' : 'none';
      document.getElementById('section-results').style.display = name === 'results' ? '' : 'none';
      clearAlert();
      if (name === 'assignments') loadAssignments();
      if (name === 'results') loadResults();
    }

    function showAlert(msg, type) {
      document.getElementById('alert-area').innerHTML = '<div class="alert alert-' + type + '">' + msg + '</div>';
    }
    function clearAlert() { document.getElementById('alert-area').innerHTML = ''; }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    function getStatusBadge(status) {
      const map = {
        'ëŒ€ê¸°': 'badge-waiting',
        'ì œì¶œì¤‘': 'badge-submitting',
        'í‰ê°€ì¤‘': 'badge-evaluating',
        'í‰ê°€ì™„ë£Œ': 'badge-eval-done',
        'í™•ì •': 'badge-finalized'
      };
      return '<span class="badge ' + (map[status] || 'badge-waiting') + '">' + status + '</span>';
    }

    // â”€â”€â”€ ë§ˆê° ì—¬ë¶€ íŒë‹¨ â”€â”€â”€
    function isBeforeDeadline(deadlineStr) {
      if (!deadlineStr) return true; // ë§ˆê°ì¼ ë¯¸ì„¤ì •ì´ë©´ ì œì¶œ ê°€ëŠ¥
      const d = new Date(deadlineStr);
      if (isNaN(d.getTime())) return true;
      return new Date() <= d;
    }

    function formatDeadline(deadlineStr) {
      if (!deadlineStr) return 'ë¯¸ì •';
      const d = new Date(deadlineStr);
      if (isNaN(d.getTime())) return String(deadlineStr);
      return d.toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    // â”€â”€â”€ ê³¼ì œ ëª©ë¡ â”€â”€â”€
    async function loadAssignments() {
      const container = document.getElementById('assignments-list');
      const loading = document.getElementById('assignments-loading');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getMyAssignments(Auth.getStudentId(), Auth.getPassword(), Auth.getCourseId());
        loading.style.display = 'none';

        if (!r.success) { container.innerHTML = '<div class="alert alert-error">' + escapeHtml(r.error) + '</div>'; return; }
        if (r.assignments.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          return;
        }

        let html = '';
        r.assignments.forEach(a => {
          html += renderAssignmentCard(a);
        });
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = '<div class="alert alert-error">ì˜¤ë¥˜: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderAssignmentCard(a) {
      const canSubmit = (a.status === 'ëŒ€ê¸°' || a.status === 'ì œì¶œì¤‘') && isBeforeDeadline(a.submitDeadline);
      const hasSubmitted = a.mySubmission !== null;
      const deadlinePassed = !isBeforeDeadline(a.submitDeadline);

      let html = '<div class="card" style="margin-bottom:16px;">';

      // â”€â”€ í—¤ë”: ê³¼ì œëª… + ìƒíƒœ ë±ƒì§€ â”€â”€
      html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
      html += '  <h3 style="font-size:1.1rem;margin:0;">' + escapeHtml(a.name) + '</h3>';
      html += '  <div>' + getStatusBadge(a.status) + '</div>';
      html += '</div>';

      // â”€â”€ ì œì¶œì¤‘/ëŒ€ê¸° ìƒíƒœ: ìƒì„¸ ì •ë³´ + ì œì¶œ UI â”€â”€
      if (a.status === 'ëŒ€ê¸°' || a.status === 'ì œì¶œì¤‘') {

        // ê³¼ì œ ì„¤ëª…
        if (a.description) {
          html += '<div style="background:var(--gray-50);border-radius:8px;padding:12px;margin-bottom:12px;">';
          html += '  <div style="font-size:0.8125rem;font-weight:600;color:var(--gray-500);margin-bottom:4px;">ê³¼ì œ ì„¤ëª…</div>';
          html += '  <div style="font-size:0.9rem;color:var(--gray-700);white-space:pre-wrap;">' + escapeHtml(a.description) + '</div>';
          html += '</div>';
        }

        // ì±„ì  ê¸°ì¤€
        if (a.criteria) {
          html += '<div style="background:#fef3c7;border-radius:8px;padding:12px;margin-bottom:12px;">';
          html += '  <div style="font-size:0.8125rem;font-weight:600;color:#92400e;margin-bottom:4px;">ì±„ì  ê¸°ì¤€ (ìµœëŒ€ ' + (a.maxScore || 100) + 'ì )</div>';
          html += '  <div style="font-size:0.875rem;color:#78350f;white-space:pre-wrap;">' + escapeHtml(a.criteria) + '</div>';
          html += '</div>';
        }

        // ë§ˆê°ì¼
        html += '<div style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:12px;">';
        html += '  ì œì¶œ ë§ˆê°: <strong>' + formatDeadline(a.submitDeadline) + '</strong>';
        if (deadlinePassed) {
          html += ' <span style="color:var(--danger);font-weight:600;">(ë§ˆê°ë¨)</span>';
        }
        html += '</div>';

        // ì œì¶œ ìƒíƒœ + UI
        if (hasSubmitted && !canSubmit) {
          // ë§ˆê° ì§€ë‚¨ + ì´ë¯¸ ì œì¶œí•¨
          html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#d1fae5;border-radius:8px;">';
          html += '  <span class="badge badge-finalized">ì œì¶œ ì™„ë£Œ</span>';
          html += '  <a href="' + escapeHtml(a.mySubmission.link) + '" target="_blank" style="color:var(--primary);font-size:0.875rem;text-decoration:underline;">ì œì¶œí•œ ë§í¬ ë³´ê¸°</a>';
          html += '</div>';
        } else if (hasSubmitted && canSubmit) {
          // ì´ë¯¸ ì œì¶œ + ì•„ì§ ë§ˆê° ì „ â†’ ì œì¶œ ì™„ë£Œ í‘œì‹œ + ë‹¤ì‹œ ì œì¶œ ë²„íŠ¼
          html += '<div id="submission-status-' + a.assignmentId + '">';
          html += '  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#d1fae5;border-radius:8px;margin-bottom:8px;">';
          html += '    <span class="badge badge-finalized">ì œì¶œ ì™„ë£Œ</span>';
          html += '    <a href="' + escapeHtml(a.mySubmission.link) + '" target="_blank" style="color:var(--primary);font-size:0.875rem;text-decoration:underline;">ì œì¶œí•œ ë§í¬ ë³´ê¸°</a>';
          html += '  </div>';
          html += '  <button class="btn btn-secondary btn-sm" onclick="showResubmitForm(\'' + a.assignmentId + '\')">ë‹¤ì‹œ ì œì¶œ</button>';
          html += '</div>';
          // ìˆ¨ê²¨ì§„ ì¬ì œì¶œ í¼
          html += '<div id="resubmit-form-' + a.assignmentId + '" style="display:none;margin-top:8px;">';
          html += renderSubmitForm(a.assignmentId);
          html += '</div>';
        } else if (!hasSubmitted && canSubmit) {
          // ë¯¸ì œì¶œ + ë§ˆê° ì „ â†’ ì œì¶œ í¼
          html += '<div id="submit-form-' + a.assignmentId + '">';
          html += renderSubmitForm(a.assignmentId);
          html += '</div>';
        } else {
          // ë¯¸ì œì¶œ + ë§ˆê° ì§€ë‚¨
          html += '<div style="padding:8px 12px;background:#fee2e2;border-radius:8px;font-size:0.875rem;color:#991b1b;">';
          html += '  ë¯¸ì œì¶œ (ë§ˆê° ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤)';
          html += '</div>';
        }

      } else if (a.status === 'í‰ê°€ì¤‘') {
        // â”€â”€ í‰ê°€ ì¤‘ ìƒíƒœ â”€â”€
        if (a.description) {
          html += '<p style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:8px;">' + escapeHtml(a.description) + '</p>';
        }
        html += '<div style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:8px;">í‰ê°€ ë§ˆê°: ' + formatDeadline(a.evalDeadline) + '</div>';

        if (hasSubmitted) {
          html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">';
          html += '  <span class="badge badge-finalized">ì œì¶œ ì™„ë£Œ</span>';
          html += '  <a href="' + escapeHtml(a.mySubmission.link) + '" target="_blank" style="color:var(--primary);font-size:0.8125rem;">ë‚´ ì œì¶œë¬¼ ë³´ê¸°</a>';
          html += '</div>';
        }

        // í‰ê°€ ì•¡ì…˜
        html += '<div style="margin-top:4px;">';
        if (a.myEvalStatus === 'completed') {
          html += '<span class="badge badge-finalized">í‰ê°€ ì™„ë£Œ</span>';
        } else if (a.myEvalStatus === 'pending') {
          html += '<a href="evaluate.html?id=' + a.assignmentId + '" class="btn btn-primary btn-sm">í‰ê°€í•˜ê¸°</a>';
        } else {
          html += '<span class="badge badge-waiting">ë¯¸ë°°ì •</span>';
        }
        html += '</div>';

      } else if (a.status === 'í™•ì •') {
        // â”€â”€ í™•ì • ìƒíƒœ â”€â”€
        if (a.description) {
          html += '<p style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:8px;">' + escapeHtml(a.description) + '</p>';
        }
        if (hasSubmitted) {
          html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">';
          html += '  <span class="badge badge-finalized">ì œì¶œ ì™„ë£Œ</span>';
          html += '  <a href="' + escapeHtml(a.mySubmission.link) + '" target="_blank" style="color:var(--primary);font-size:0.8125rem;">ë‚´ ì œì¶œë¬¼ ë³´ê¸°</a>';
          html += '</div>';
        }
        html += '<div style="margin-top:4px;">';
        html += '  <a href="results.html?id=' + a.assignmentId + '" class="btn btn-secondary btn-sm">ê²°ê³¼ ë³´ê¸°</a>';
        html += '</div>';

      } else {
        // í‰ê°€ì™„ë£Œ ë“±
        if (a.description) {
          html += '<p style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:8px;">' + escapeHtml(a.description) + '</p>';
        }
        html += '<div style="font-size:0.8125rem;color:var(--gray-500);">ê²°ê³¼ í™•ì • ëŒ€ê¸° ì¤‘</div>';
      }

      html += '</div>';
      return html;
    }

    function renderSubmitForm(assignmentId) {
      let html = '';
      html += '<div style="border:1px solid var(--gray-200);border-radius:8px;padding:12px;background:white;">';
      html += '  <div class="form-group" style="margin-bottom:8px;">';
      html += '    <label for="submit-url-' + assignmentId + '" style="font-size:0.875rem;font-weight:600;">ê³¼ì œ ë¬¸ì„œ URL</label>';
      html += '    <input type="url" id="submit-url-' + assignmentId + '" placeholder="https://docs.google.com/document/d/..." style="width:100%;padding:8px 12px;border:1px solid var(--gray-300);border-radius:6px;font-size:0.875rem;">';
      html += '  </div>';
      html += '  <p style="font-size:0.75rem;color:var(--gray-500);margin-bottom:10px;">';
      html += '    êµ¬ê¸€ ë¬¸ì„œ/ë“œë¼ì´ë¸Œ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”. <strong>ë°˜ë“œì‹œ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì" ë˜ëŠ” "@kookmin.ac.kr" ë„ë©”ì¸ì— ì½ê¸° ê¶Œí•œ</strong>ì„ ë¶€ì—¬í•´ì£¼ì„¸ìš”.';
      html += '  </p>';
      html += '  <button class="btn btn-primary btn-sm" id="btn-submit-' + assignmentId + '" onclick="submitAssignmentAction(\'' + assignmentId + '\')">ì œì¶œí•˜ê¸°</button>';
      html += '  <span id="submit-status-' + assignmentId + '" style="margin-left:8px;font-size:0.8125rem;"></span>';
      html += '</div>';
      return html;
    }

    function showResubmitForm(assignmentId) {
      var statusEl = document.getElementById('submission-status-' + assignmentId);
      var formEl = document.getElementById('resubmit-form-' + assignmentId);
      if (statusEl) statusEl.style.display = 'none';
      if (formEl) formEl.style.display = '';
    }

    async function submitAssignmentAction(assignmentId) {
      var urlInput = document.getElementById('submit-url-' + assignmentId);
      var btn = document.getElementById('btn-submit-' + assignmentId);
      var status = document.getElementById('submit-status-' + assignmentId);
      var link = urlInput.value.trim();

      if (!link) {
        status.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        status.style.color = 'var(--danger)';
        return;
      }

      if (!link.match(/^https?:\/\//i)) {
        status.textContent = 'http:// ë˜ëŠ” https://ë¡œ ì‹œì‘í•˜ëŠ” URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        status.style.color = 'var(--danger)';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ì œì¶œ ì¤‘...';
      status.textContent = '';

      try {
        var r = await API.submitAssignment(
          Auth.getStudentId(), Auth.getPassword(), Auth.getCourseId(),
          assignmentId, link
        );
        if (r.success) {
          showAlert(r.message, 'success');
          // ê³¼ì œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadAssignments();
        } else {
          status.textContent = r.error;
          status.style.color = 'var(--danger)';
        }
      } catch (err) {
        status.textContent = 'ì˜¤ë¥˜: ' + err.message;
        status.style.color = 'var(--danger)';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ì œì¶œí•˜ê¸°';
      }
    }

    // â”€â”€â”€ ê²°ê³¼ ë³´ê¸° â”€â”€â”€
    async function loadResults() {
      const container = document.getElementById('results-list');
      const loading = document.getElementById('results-loading');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getMyResults(Auth.getStudentId(), Auth.getPassword(), Auth.getCourseId());
        loading.style.display = 'none';

        if (!r.success) { container.innerHTML = '<div class="alert alert-error">' + escapeHtml(r.error) + '</div>'; return; }
        if (r.results.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>í™•ì •ëœ ê²°ê³¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          return;
        }

        let html = '';
        r.results.forEach(res => {
          const avgScore = res.receivedScores.length > 0
            ? (res.receivedScores.reduce((s, e) => s + Number(e.score), 0) / res.receivedScores.length).toFixed(1)
            : '-';

          html += '<div class="card"><div class="card-title">' + escapeHtml(res.assignmentName) + '</div>';
          html += '<h4 style="font-size:0.9rem;color:var(--gray-600);margin-bottom:12px;">ë°›ì€ í‰ê°€ (ìƒí˜¸í‰ê°€ í‰ê· : ' + avgScore + 'ì )</h4>';

          res.receivedScores.forEach((ev, idx) => {
            html += '<div class="result-item">';
            html += '  <div class="score-label">í‰ê°€ ' + (idx + 1) + '</div>';
            html += '  <div class="score-value">' + ev.score + 'ì </div>';
            html += '  <div class="comment-text">' + escapeHtml(ev.comment) + '</div>';
            html += '</div>';
          });

          if (res.professorScore !== null) {
            html += '<div class="result-item professor-eval">';
            html += '  <div class="score-label">êµìˆ˜ í‰ê°€</div>';
            html += '  <div class="score-value">' + res.professorScore + 'ì </div>';
            html += '  <div class="comment-text">' + escapeHtml(res.professorComment || '') + '</div>';
            html += '</div>';
          }

          html += '</div>';
        });
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = '<div class="alert alert-error">ì˜¤ë¥˜: ' + escapeHtml(err.message) + '</div>';
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadAssignments();
  </script>
</body>
</html>
