<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµìˆ˜ ëŒ€ì‹œë³´ë“œ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ê´€ë¦¬</h1>
      <div class="user-info">
        <span id="course-info"></span>
        <span id="current-course-badge" style="background:#e0e7ff;color:#3730a3;padding:4px 12px;border-radius:12px;font-size:0.8125rem;font-weight:600;margin-right:8px;display:none;"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('assignments')">ê³¼ì œ ê´€ë¦¬</button>
      <button class="nav-tab" onclick="showTab('create')">ìƒˆ ê³¼ì œ</button>
      <button class="nav-tab" onclick="showTab('students')">í•™ìƒ ê´€ë¦¬</button>
      <button class="nav-tab" onclick="showTab('courses')">ê³¼ëª© ê´€ë¦¬</button>
    </div>

    <div id="alert-area"></div>

    <!-- â”€â”€â”€ ê³¼ì œ ê´€ë¦¬ íƒ­ â”€â”€â”€ -->
    <div id="tab-assignments">
      <div id="assignments-loading" class="loading">
        <div class="spinner"></div>
        <span>ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div id="assignments-list"></div>
    </div>

    <!-- â”€â”€â”€ ê³¼ì œ ìƒì„± íƒ­ â”€â”€â”€ -->
    <div id="tab-create" style="display:none;">
      <div class="card">
        <div class="card-title">ìƒˆ ê³¼ì œ ë§Œë“¤ê¸°</div>
        <div class="form-group">
          <label for="new-name">ê³¼ì œëª… *</label>
          <input type="text" id="new-name" placeholder="ì˜ˆ: UML í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±">
        </div>
        <div class="form-group">
          <label for="new-desc">ê³¼ì œ ì„¤ëª…</label>
          <textarea id="new-desc" placeholder="ê³¼ì œì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label for="new-deadline">ì œì¶œ ë§ˆê°ì¼ì‹œ</label>
            <input type="datetime-local" id="new-deadline">
          </div>
          <div class="form-group">
            <label for="new-max">ìµœëŒ€ ì ìˆ˜</label>
            <input type="number" id="new-max" value="100" min="1">
          </div>
        </div>
        <div class="form-group">
          <label for="new-criteria">ì±„ì  ê¸°ì¤€</label>
          <textarea id="new-criteria" placeholder="ì˜ˆ: 1) í´ë˜ìŠ¤ ì‹ë³„ ì ì ˆì„±(30ì ) 2) ê´€ê³„ í‘œí˜„ ì •í™•ì„±(40ì ) ..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="createAssignment()" id="btn-create">ê³¼ì œ ìƒì„±</button>
      </div>
    </div>

    <!-- â”€â”€â”€ í•™ìƒ ê´€ë¦¬ íƒ­ â”€â”€â”€ -->
    <div id="tab-students" style="display:none;">
      <div class="card">
        <div class="card-title">í•™ìƒ ì¼ê´„ ë“±ë¡</div>
        <div class="form-group">
          <label for="students-csv">í•™ìƒ ëª©ë¡ (íƒ­ êµ¬ë¶„: í•™ë²ˆ, ì´ë¦„)</label>
          <textarea id="students-csv" rows="6" placeholder="20210001&#9;ê¹€ë¯¼ìˆ˜
20210002&#9;ì´ì„œì—°"></textarea>
          <div class="hint">ì—‘ì…€ì—ì„œ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•˜ë©´ íƒ­ìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤. (í•™ë²ˆ, ì´ë¦„ 2ì—´)</div>
        </div>
        <button class="btn btn-primary" onclick="registerStudents()" id="btn-register">ë“±ë¡</button>
      </div>

      <div class="card">
        <div class="card-title">ë“±ë¡ëœ í•™ìƒ ëª©ë¡</div>
        <div id="students-loading" class="loading" style="display:none;">
          <div class="spinner"></div>
        </div>
        <div id="students-table"></div>
      </div>
    </div>

    <!-- â”€â”€â”€ ê³¼ëª© ê´€ë¦¬ íƒ­ â”€â”€â”€ -->
    <div id="tab-courses" style="display:none;">
      <!-- ìƒˆ ê³¼ëª© ì¶”ê°€ í¼ -->
      <div class="card">
        <div class="card-title">ìƒˆ ê³¼ëª© ì¶”ê°€</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
          <div class="form-group" style="flex:2;min-width:180px;margin-bottom:0;">
            <label for="new-course-name">ê³¼ëª© ì´ë¦„</label>
            <input type="text" id="new-course-name" placeholder="ì˜ˆ: ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™ê°œë¡ ">
          </div>
          <div class="form-group" style="flex:1;min-width:100px;margin-bottom:0;">
            <label for="new-course-year">ë…„ë„</label>
            <input type="number" id="new-course-year" placeholder="2026" value="2026">
          </div>
          <div class="form-group" style="flex:1;min-width:100px;margin-bottom:0;">
            <label for="new-course-semester">í•™ê¸°</label>
            <select id="new-course-semester">
              <option value="1">1í•™ê¸°</option>
              <option value="2">2í•™ê¸°</option>
              <option value="summer">ì—¬ë¦„í•™ê¸°</option>
              <option value="winter">ê²¨ìš¸í•™ê¸°</option>
            </select>
          </div>
          <button class="btn btn-primary" id="btn-create-course" onclick="createCourseAction()" style="height:40px;">ê³¼ëª© ì¶”ê°€</button>
        </div>
      </div>
      <!-- ê³¼ëª© ëª©ë¡ -->
      <div class="card">
        <div class="card-title">ê³¼ëª© ëª©ë¡</div>
        <div id="courses-loading" class="loading" style="display:none;">
          <div class="spinner"></div>
          <span>ê³¼ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
        <div id="courses-table"></div>
      </div>
    </div>

    <!-- â”€â”€â”€ ê³¼ì œ ìƒì„¸ ëª¨ë‹¬ ì˜ì—­ â”€â”€â”€ -->
    <div id="detail-area" style="display:none;"></div>
  </div>

  <!-- ìƒí˜¸í‰ê°€ ì‹œì‘ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modal-start-eval">
    <div class="modal">
      <h2>ìƒí˜¸í‰ê°€ ì‹œì‘</h2>
      <p style="margin-bottom:16px;color:var(--gray-600);font-size:0.9rem;" id="start-eval-info"></p>
      <div class="form-group">
        <label for="eval-deadline">í‰ê°€ ë§ˆê°ì¼ì‹œ *</label>
        <input type="datetime-local" id="eval-deadline">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('modal-start-eval')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="confirmStartEval()" id="btn-start-eval">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    if (!Auth.requireAdmin()) throw new Error('Redirect');

    const session = Auth.getSession();
    document.getElementById('course-info').textContent =
      (session.courseName || 'ìˆ˜ì—…') + ' ' + (session.semester || '');

    const adminPw = Auth.getAdminPassword();
    let currentAssignments = [];
    let currentAssignmentId = '';

    // â”€â”€ v2.1: í˜„ì¬ ì„ íƒëœ ê³¼ëª© ê´€ë¦¬ â”€â”€
    const SELECTED_COURSE_KEY = 'cross_eval_selected_course';

    function getSelectedCourse() {
      const raw = sessionStorage.getItem(SELECTED_COURSE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function setSelectedCourse(courseId, courseName) {
      sessionStorage.setItem(SELECTED_COURSE_KEY, JSON.stringify({ courseId, courseName }));
      updateCurrentCourseBadge();
    }

    function updateCurrentCourseBadge() {
      const badge = document.getElementById('current-course-badge');
      const selected = getSelectedCourse();
      if (selected && selected.courseName) {
        badge.textContent = 'ğŸ“š ' + selected.courseName;
        badge.style.display = '';
      } else {
        badge.textContent = '';
        badge.style.display = 'none';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì„ íƒ ê³¼ëª© í‘œì‹œ
    updateCurrentCourseBadge();

    function showTab(name) {
      ['assignments', 'create', 'students', 'courses'].forEach(t => {
        document.getElementById('tab-' + t).style.display = t === name ? '' : 'none';
      });
      document.querySelectorAll('.nav-tab').forEach((tab, i) => {
        const tabs = ['assignments', 'create', 'students', 'courses'];
        tab.classList.toggle('active', tabs[i] === name);
      });
      document.getElementById('detail-area').style.display = 'none';
      clearAlert();

      if (name === 'assignments') loadAssignments();
      if (name === 'students') loadStudents();
      if (name === 'courses') loadCourses();
    }

    function showAlert(msg, type) {
      document.getElementById('alert-area').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }
    function clearAlert() { document.getElementById('alert-area').innerHTML = ''; }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }

    function getStatusBadge(status) {
      const m = { 'ëŒ€ê¸°':'badge-waiting', 'ì œì¶œì¤‘':'badge-submitting', 'í‰ê°€ì¤‘':'badge-evaluating', 'í‰ê°€ì™„ë£Œ':'badge-eval-done', 'í™•ì •':'badge-finalized' };
      return `<span class="badge ${m[status]||'badge-waiting'}">${status}</span>`;
    }

    // â”€â”€â”€ ê³¼ì œ ëª©ë¡ â”€â”€â”€
    async function loadAssignments() {
      const loading = document.getElementById('assignments-loading');
      const container = document.getElementById('assignments-list');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getAssignmentsList(adminPw);
        loading.style.display = 'none';
        if (!r.success) { container.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }

        currentAssignments = r.assignments;
        if (r.assignments.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ ê³¼ì œ" íƒ­ì—ì„œ ìƒì„±í•˜ì„¸ìš”.</p></div>';
          return;
        }

        let html = '';
        r.assignments.forEach(a => {
          let actions = '';
          switch (a.status) {
            case 'ëŒ€ê¸°':
              actions = `<button class="btn btn-warning btn-sm" onclick="openStartEvalModal('${a.assignmentId}')">ìƒí˜¸í‰ê°€ ì‹œì‘</button>`;
              break;
            case 'í‰ê°€ì¤‘':
              actions = `
                <button class="btn btn-secondary btn-sm" onclick="showEvalStatus('${a.assignmentId}')">ì§„í–‰ í˜„í™©</button>
                <button class="btn btn-danger btn-sm" onclick="endEvaluation('${a.assignmentId}')">í‰ê°€ ì¢…ë£Œ</button>`;
              break;
            case 'í‰ê°€ì™„ë£Œ':
              actions = `
                <button class="btn btn-secondary btn-sm" onclick="showProfessorEval('${a.assignmentId}')">êµìˆ˜ í‰ê°€</button>
                <button class="btn btn-success btn-sm" onclick="finalize('${a.assignmentId}')">í™•ì •</button>`;
              break;
            case 'í™•ì •':
              actions = `<button class="btn btn-secondary btn-sm" onclick="showAllResults('${a.assignmentId}')">ê²°ê³¼ ë³´ê¸°</button>`;
              break;
          }

          html += `
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;">
                <div>
                  <h3 style="font-size:1.05rem;margin-bottom:4px;">${escapeHtml(a.name)}</h3>
                  <p style="font-size:0.8125rem;color:var(--gray-500);">${a.assignmentId} | ì œì¶œë§ˆê°: ${a.submitDeadline || '-'} | í‰ê°€ë§ˆê°: ${a.evalDeadline || '-'}</p>
                </div>
                ${getStatusBadge(a.status)}
              </div>
              <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                ${actions}
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    // â”€â”€â”€ ê³¼ì œ ìƒì„± â”€â”€â”€
    async function createAssignment() {
      const name = document.getElementById('new-name').value.trim();
      if (!name) { showAlert('ê³¼ì œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

      const btn = document.getElementById('btn-create');
      btn.disabled = true; btn.textContent = 'ìƒì„± ì¤‘...';

      try {
        const r = await API.createAssignment(adminPw, {
          name: name,
          description: document.getElementById('new-desc').value.trim(),
          submitDeadline: document.getElementById('new-deadline').value,
          criteria: document.getElementById('new-criteria').value.trim(),
          minScore: 0,
          maxScore: Number(document.getElementById('new-max').value) || 100
        });

        if (!r.success) { showAlert(r.error, 'error'); return; }

        showAlert(r.message, 'success');
        // í¼ ì´ˆê¸°í™”
        ['new-name','new-desc','new-criteria'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('new-deadline').value = '';

        // ê³¼ì œ ëª©ë¡ íƒ­ìœ¼ë¡œ ì´ë™
        setTimeout(() => showTab('assignments'), 1000);
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ê³¼ì œ ìƒì„±';
      }
    }

    // â”€â”€â”€ ìƒí˜¸í‰ê°€ ì‹œì‘ â”€â”€â”€
    function openStartEvalModal(assignmentId) {
      currentAssignmentId = assignmentId;
      const a = currentAssignments.find(x => x.assignmentId === assignmentId);
      document.getElementById('start-eval-info').textContent =
        `"${a ? a.name : assignmentId}" ê³¼ì œì˜ ìƒí˜¸í‰ê°€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì¤‘ë³µ ì œì¶œì´ ì •ë¦¬ë˜ê³ , í‰ê°€ìê°€ ìë™ ë°°ì •ë©ë‹ˆë‹¤.`;
      openModal('modal-start-eval');
    }

    async function confirmStartEval() {
      const deadline = document.getElementById('eval-deadline').value;
      if (!deadline) { alert('í‰ê°€ ë§ˆê°ì¼ì‹œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }

      const btn = document.getElementById('btn-start-eval');
      btn.disabled = true; btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

      try {
        const r = await API.startEvaluation(adminPw, currentAssignmentId, deadline);
        closeModal('modal-start-eval');

        if (!r.success) { showAlert(r.error, 'error'); return; }

        showAlert(`ìƒí˜¸í‰ê°€ ì‹œì‘! ìœ íš¨ ì œì¶œì ${r.validStudents}ëª…, ì´ ${r.totalAssignments}ê±´ ë°°ì •`, 'success');
        loadAssignments();
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ì‹œì‘';
      }
    }

    // â”€â”€â”€ í‰ê°€ í˜„í™© â”€â”€â”€
    async function showEvalStatus(assignmentId) {
      const detail = document.getElementById('detail-area');
      detail.style.display = '';
      detail.innerHTML = '<div class="loading"><div class="spinner"></div><span>í˜„í™© ë¡œë”© ì¤‘...</span></div>';

      try {
        const r = await API.getEvalStatus(adminPw, assignmentId);
        if (!r.success) { detail.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }

        let html = `
          <div class="card">
            <div class="card-title">í‰ê°€ ì§„í–‰ í˜„í™© - ${assignmentId}</div>
            <div class="grid-3" style="margin-bottom:20px;">
              <div class="stat-card">
                <div class="stat-value">${r.completedCount}</div>
                <div class="stat-label">ì™„ë£Œ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${r.totalCount - r.completedCount}</div>
                <div class="stat-label">ë¯¸ì™„ë£Œ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${r.progress}%</div>
                <div class="stat-label">ì§„í–‰ë¥ </div>
              </div>
            </div>
            <div class="progress-bar"><div class="fill" style="width:${r.progress}%"></div></div>
            <div class="table-wrapper" style="margin-top:16px;">
              <table>
                <thead><tr><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>í‰ê°€1</th><th>í‰ê°€2</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>
        `;
        r.students.forEach(s => {
          html += `<tr>
            <td>${escapeHtml(s.studentId)}</td>
            <td>${escapeHtml(s.name)}</td>
            <td>${s.eval1Done ? 'âœ…' : 'âŒ'}</td>
            <td>${s.eval2Done ? 'âœ…' : 'âŒ'}</td>
            <td>${s.allDone ? '<span class="badge badge-finalized">ì™„ë£Œ</span>' : '<span class="badge badge-evaluating">ì§„í–‰ì¤‘</span>'}</td>
          </tr>`;
        });
        html += '</tbody></table></div><button class="btn btn-secondary btn-sm" onclick="document.getElementById(\'detail-area\').style.display=\'none\'" style="margin-top:12px;">ë‹«ê¸°</button></div>';
        detail.innerHTML = html;
      } catch (err) {
        detail.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    // â”€â”€â”€ í‰ê°€ ì¢…ë£Œ â”€â”€â”€
    async function endEvaluation(assignmentId) {
      if (!confirm(`"${assignmentId}" í‰ê°€ë¥¼ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ ì§‘ê³„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const r = await API.endEvaluation(adminPw, assignmentId);
        if (!r.success) { showAlert(r.error, 'error'); return; }

        let msg = `í‰ê°€ ì¢…ë£Œ ë° ì§‘ê³„ ì™„ë£Œ (${r.totalStudents}ëª…).`;
        if (r.incompleteEvaluations && r.incompleteEvaluations.length > 0) {
          msg += ` ë¯¸ì™„ë£Œ í‰ê°€ ${r.incompleteEvaluations.length}ê±´ ìˆìŒ.`;
        }
        showAlert(msg, 'success');
        loadAssignments();
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ êµìˆ˜ í‰ê°€ â”€â”€â”€
    async function showProfessorEval(assignmentId) {
      const detail = document.getElementById('detail-area');
      detail.style.display = '';
      detail.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const r = await API.getAllResults(adminPw, assignmentId);
        if (!r.success) { detail.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }

        let html = `<div class="card"><div class="card-title">êµìˆ˜ í‰ê°€ ì…ë ¥ - ${assignmentId}</div>`;

        r.results.forEach((s, idx) => {
          const peerAvg = s.received.length > 0
            ? (s.received.reduce((sum, e) => sum + Number(e.score), 0) / s.received.length).toFixed(1)
            : '-';

          html += `
            <div class="eval-target" style="margin-bottom:16px;">
              <div class="target-header">
                <span class="target-name">${escapeHtml(s.name)} (${s.studentId})</span>
                <span style="font-size:0.8125rem;color:var(--gray-500);">ìƒí˜¸í‰ê°€ í‰ê· : ${peerAvg}</span>
              </div>
              <p style="margin-bottom:8px;">
                <a href="${escapeHtml(s.submissionLink)}" target="_blank" class="submission-link">ğŸ“ ê³¼ì œë¬¼ ë³´ê¸°</a>
              </p>
              <div style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:8px;">
                ${s.received.map(e => `${e.score}ì `).join(', ')}
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label>ì ìˆ˜</label>
                  <input type="number" id="prof-score-${idx}" value="${s.professorScore || ''}" min="0" max="100">
                </div>
                <div class="form-group">
                  <label>ì„œìˆ í‰</label>
                  <input type="text" id="prof-comment-${idx}" value="${escapeHtml(s.professorComment || '')}" placeholder="êµìˆ˜ ì½”ë©˜íŠ¸">
                </div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="saveProfEval('${assignmentId}','${s.studentId}',${idx})">ì €ì¥</button>
              <span id="prof-status-${idx}" style="margin-left:8px;font-size:0.8125rem;"></span>
            </div>
          `;
        });

        html += '<button class="btn btn-secondary" onclick="document.getElementById(\'detail-area\').style.display=\'none\'" style="margin-top:8px;">ë‹«ê¸°</button></div>';
        detail.innerHTML = html;
      } catch (err) {
        detail.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    async function saveProfEval(assignmentId, studentId, idx) {
      const score = document.getElementById('prof-score-' + idx).value;
      const comment = document.getElementById('prof-comment-' + idx).value;
      const status = document.getElementById('prof-status-' + idx);

      if (score === '') { alert('ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      try {
        const r = await API.submitProfessorEval(adminPw, assignmentId, studentId, Number(score), comment);
        status.textContent = r.success ? 'âœ… ì €ì¥ë¨' : 'âŒ ' + r.error;
        status.style.color = r.success ? 'var(--success)' : 'var(--danger)';
      } catch (err) {
        status.textContent = 'âŒ ì˜¤ë¥˜';
        status.style.color = 'var(--danger)';
      }
    }

    // â”€â”€â”€ í™•ì • â”€â”€â”€
    async function finalize(assignmentId) {
      if (!confirm(`"${assignmentId}"ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•™ìƒì—ê²Œ ê²°ê³¼ê°€ ê³µê°œë©ë‹ˆë‹¤.`)) return;

      try {
        const r = await API.finalizeAssignment(adminPw, assignmentId, false);
        if (!r.success) {
          if (r.incomplete && r.incomplete.length > 0) {
            const names = r.incomplete.map(s => s.name).join(', ');
            if (confirm(`êµìˆ˜ í‰ê°€ ë¯¸ì™„ë£Œ: ${names}\nê·¸ë˜ë„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              const r2 = await API.finalizeAssignment(adminPw, assignmentId, true);
              if (r2.success) { showAlert(r2.message, 'success'); loadAssignments(); }
              else showAlert(r2.error, 'error');
            }
          } else {
            showAlert(r.error, 'error');
          }
          return;
        }
        showAlert(r.message, 'success');
        loadAssignments();
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ ì „ì²´ ê²°ê³¼ ë³´ê¸° â”€â”€â”€
    async function showAllResults(assignmentId) {
      const detail = document.getElementById('detail-area');
      detail.style.display = '';
      detail.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const r = await API.getAllResults(adminPw, assignmentId);
        if (!r.success) { detail.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }

        let html = `<div class="card"><div class="card-title">ì „ì²´ ê²°ê³¼ - ${assignmentId}</div>
          <div class="table-wrapper"><table>
            <thead><tr><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ë°›ì€1</th><th>ë°›ì€2</th><th>í‰ê· </th><th>êµìˆ˜</th></tr></thead><tbody>`;

        r.results.forEach(s => {
          const scores = s.received.map(e => Number(e.score));
          const avg = scores.length > 0 ? (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(1) : '-';
          html += `<tr>
            <td>${s.studentId}</td><td>${escapeHtml(s.name)}</td>
            <td>${scores[0] !== undefined ? scores[0] : '-'}</td>
            <td>${scores[1] !== undefined ? scores[1] : '-'}</td>
            <td><strong>${avg}</strong></td>
            <td><strong>${s.professorScore || '-'}</strong></td>
          </tr>`;
        });

        html += '</tbody></table></div><button class="btn btn-secondary btn-sm" onclick="document.getElementById(\'detail-area\').style.display=\'none\'" style="margin-top:12px;">ë‹«ê¸°</button></div>';
        detail.innerHTML = html;
      } catch (err) {
        detail.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    // â”€â”€â”€ í•™ìƒ ë“±ë¡ â”€â”€â”€
    async function registerStudents() {
      const csv = document.getElementById('students-csv').value.trim();
      if (!csv) { showAlert('í•™ìƒ ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

      const students = csv.split('\n').map(line => {
        const parts = line.split('\t');
        if (parts.length < 2) return null;
        return {
          studentId: parts[0].trim(),
          name: parts[1].trim()
        };
      }).filter(s => s !== null && s.studentId && s.name);

      if (students.length === 0) { showAlert('ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (í•™ë²ˆ, ì´ë¦„ì„ íƒ­ìœ¼ë¡œ êµ¬ë¶„)', 'error'); return; }

      const btn = document.getElementById('btn-register');
      btn.disabled = true; btn.textContent = 'ë“±ë¡ ì¤‘...';

      try {
        const r = await API.registerStudents(adminPw, students);
        if (!r.success) { showAlert(r.error, 'error'); return; }
        showAlert(r.message, 'success');
        document.getElementById('students-csv').value = '';
        loadStudents();
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ë“±ë¡';
      }
    }

    async function loadStudents() {
      const container = document.getElementById('students-table');
      const loading = document.getElementById('students-loading');
      loading.style.display = '';

      try {
        const r = await API.getStudentsList(adminPw);
        loading.style.display = 'none';
        if (!r.success) { container.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }
        if (r.students.length === 0) {
          container.innerHTML = '<p style="color:var(--gray-400);">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        let html = `<div class="table-wrapper"><table>
          <thead><tr><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
        r.students.forEach(s => {
          html += `<tr>
            <td>${escapeHtml(s.studentId)}</td>
            <td>${escapeHtml(s.name)}</td>
            <td>${s.hasPassword ? 'âœ… ì„¤ì •ë¨' : 'âŒ ë¯¸ì„¤ì •'}</td>
            <td style="display:flex;gap:4px;flex-wrap:wrap;">
              ${s.hasPassword ? `<button class="btn btn-warning btn-sm" onclick="resetPw('${s.studentId}')">PW ì´ˆê¸°í™”</button>` : ''}
              <button class="btn btn-danger btn-sm" onclick="removeStudent('${s.studentId}','${escapeHtml(s.name)}')">ì‚­ì œ</button>
            </td>
          </tr>`;
        });
        html += `</tbody></table></div><p style="font-size:0.8125rem;color:var(--gray-500);margin-top:8px;">ì´ ${r.students.length}ëª…</p>`;
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    async function resetPw(studentId) {
      if (!confirm(`${studentId} í•™ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        const r = await API.resetPassword(adminPw, studentId);
        if (r.success) { showAlert(r.message, 'success'); loadStudents(); }
        else showAlert(r.error, 'error');
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    async function removeStudent(studentId, name) {
      if (!confirm(`${name}(${studentId}) í•™ìƒì„ ì´ ê³¼ëª©ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ê¸°ì¡´ ì œì¶œ/í‰ê°€ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`)) return;
      try {
        const r = await API.removeStudent(adminPw, studentId);
        if (r.success) { showAlert(r.message, 'success'); loadStudents(); }
        else showAlert(r.error, 'error');
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ ê³¼ëª© ê´€ë¦¬ â”€â”€â”€
    async function createCourseAction() {
      const name = document.getElementById('new-course-name').value.trim();
      const year = document.getElementById('new-course-year').value.trim();
      const semester = document.getElementById('new-course-semester').value;

      if (!name) { showAlert('ê³¼ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
      if (!year) { showAlert('ë…„ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

      const btn = document.getElementById('btn-create-course');
      btn.disabled = true;
      btn.textContent = 'ìƒì„± ì¤‘...';

      try {
        const r = await API.createCourse(adminPw, name, year, semester);
        if (r.success) {
          showAlert(r.message, 'success');
          document.getElementById('new-course-name').value = '';
          // ìë™ìœ¼ë¡œ ìƒˆë¡œ ë§Œë“  ê³¼ëª© ì„ íƒ
          setSelectedCourse(r.courseId, name);
          loadCourses();
        } else {
          showAlert(r.error, 'error');
        }
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ê³¼ëª© ì¶”ê°€';
      }
    }

    function selectCourse(courseId, courseName) {
      setSelectedCourse(courseId, courseName);
      showAlert(`'${courseName}' ê³¼ëª©ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
      loadCourses(); // ì„ íƒ ìƒíƒœ UI ê°±ì‹ 
    }

    async function loadCourses() {
      const container = document.getElementById('courses-table');
      const loading = document.getElementById('courses-loading');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getCoursesList(adminPw);
        loading.style.display = 'none';
        if (!r.success) { container.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }
        if (r.courses.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“š</div><p>ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ í¼ì—ì„œ ìƒˆ ê³¼ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.</p></div>';
          return;
        }

        const selected = getSelectedCourse();
        let html = `<div class="table-wrapper"><table>
          <thead><tr><th>ê³¼ëª©ID</th><th>ê³¼ëª©ëª…</th><th>ë…„ë„</th><th>í•™ê¸°</th><th>ìƒì„±ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
        r.courses.forEach(c => {
          const isDeleted = c.status === 'ì‚­ì œë¨';
          const isSelected = selected && selected.courseId === c.courseId;
          const statusBadge = isDeleted
            ? '<span class="badge badge-danger" style="background:#fee2e2;color:#dc2626;">ì‚­ì œë¨</span>'
            : isSelected
              ? '<span class="badge" style="background:#dbeafe;color:#1d4ed8;">ì„ íƒë¨</span>'
              : '<span class="badge badge-finalized">í™œì„±</span>';

          let actionBtns = '';
          if (isDeleted) {
            actionBtns = `<button class="btn btn-success btn-sm" onclick="restoreCourse('${escapeHtml(c.courseId)}','${escapeHtml(c.courseName)}')">ë³µì›</button>`;
          } else {
            const selectBtn = isSelected
              ? '<button class="btn btn-sm" style="background:#dbeafe;color:#1d4ed8;cursor:default;" disabled>ì„ íƒë¨</button>'
              : `<button class="btn btn-primary btn-sm" onclick="selectCourse('${escapeHtml(c.courseId)}','${escapeHtml(c.courseName)}')">ì„ íƒ</button>`;
            actionBtns = `<div style="display:flex;gap:4px;">${selectBtn}<button class="btn btn-danger btn-sm" onclick="deleteCourse('${escapeHtml(c.courseId)}','${escapeHtml(c.courseName)}')">ì‚­ì œ</button></div>`;
          }

          const rowStyle = isDeleted ? 'opacity:0.4;' : isSelected ? 'background:#eff6ff;' : '';
          html += `<tr style="${rowStyle}">
            <td>${escapeHtml(c.courseId)}</td>
            <td><strong>${escapeHtml(c.courseName)}</strong></td>
            <td>${escapeHtml(String(c.year))}</td>
            <td>${escapeHtml(String(c.semester))}</td>
            <td>${escapeHtml(String(c.createdAt).substring(0, 10))}</td>
            <td>${statusBadge}</td>
            <td>${actionBtns}</td>
          </tr>`;
        });
        html += `</tbody></table></div><p style="font-size:0.8125rem;color:var(--gray-500);margin-top:8px;">ì´ ${r.courses.length}ê°œ ê³¼ëª©</p>`;
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    async function deleteCourse(courseId, courseName) {
      if (!confirm(`'${courseName}' (${courseId}) ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ê³¼ëª© ë°ì´í„°(ìŠ¤í”„ë ˆë“œì‹œíŠ¸)ëŠ” ë³´ì¡´ë˜ë©°, ê³¼ëª© ëª©ë¡ì—ì„œë§Œ ì‚­ì œ í‘œì‹œë©ë‹ˆë‹¤.`)) return;
      if (!confirm(`ì •ë§ë¡œ '${courseName}' ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë³µì› ê°€ëŠ¥í•©ë‹ˆë‹¤.`)) return;

      try {
        const r = await API.deleteCourse(adminPw, courseId);
        if (r.success) {
          showAlert(r.message, 'success');
          // ì‚­ì œëœ ê³¼ëª©ì´ í˜„ì¬ ì„ íƒëœ ê³¼ëª©ì´ë©´ ì„ íƒ í•´ì œ
          const selected = getSelectedCourse();
          if (selected && selected.courseId === courseId) {
            sessionStorage.removeItem(SELECTED_COURSE_KEY);
            updateCurrentCourseBadge();
          }
          loadCourses();
        }
        else showAlert(r.error, 'error');
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    async function restoreCourse(courseId, courseName) {
      if (!confirm(`'${courseName}' (${courseId}) ê³¼ëª©ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      if (!confirm(`ì •ë§ë¡œ '${courseName}' ê³¼ëª©ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const r = await API.restoreCourse(adminPw, courseId);
        if (r.success) { showAlert(r.message, 'success'); loadCourses(); }
        else showAlert(r.error, 'error');
      } catch (err) {
        showAlert('ì˜¤ë¥˜: ' + err.message, 'error');
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadAssignments();
  </script>
</body>
</html>
