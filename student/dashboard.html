<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - ìƒí˜¸í‰ê°€</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1>ìƒí˜¸í‰ê°€ ì‹œìŠ¤í…œ</h1>
      <div class="user-info">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('assignments')">ê³¼ì œ ëª©ë¡</button>
      <button class="nav-tab" onclick="showSection('results')">ë‚´ ê²°ê³¼</button>
    </div>

    <div id="section-assignments">
      <div id="assignments-loading" class="loading">
        <div class="spinner"></div>
        <span>ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div id="assignments-list"></div>
    </div>

    <div id="section-results" style="display:none;">
      <div id="results-loading" class="loading">
        <div class="spinner"></div>
        <span>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div id="results-list"></div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    if (!Auth.requireStudent()) throw new Error('Redirect');

    document.getElementById('user-name').textContent = Auth.getUserName() + ' (' + Auth.getStudentId() + ')';

    function showSection(name) {
      document.querySelectorAll('.nav-tab').forEach((t, i) => {
        t.classList.toggle('active', (name === 'assignments' && i === 0) || (name === 'results' && i === 1));
      });
      document.getElementById('section-assignments').style.display = name === 'assignments' ? '' : 'none';
      document.getElementById('section-results').style.display = name === 'results' ? '' : 'none';

      if (name === 'assignments') loadAssignments();
      if (name === 'results') loadResults();
    }

    function getStatusBadge(status) {
      const map = {
        'ëŒ€ê¸°': 'badge-waiting',
        'ì œì¶œì¤‘': 'badge-submitting',
        'í‰ê°€ì¤‘': 'badge-evaluating',
        'í‰ê°€ì™„ë£Œ': 'badge-eval-done',
        'í™•ì •': 'badge-finalized'
      };
      return `<span class="badge ${map[status] || 'badge-waiting'}">${status}</span>`;
    }

    async function loadAssignments() {
      const container = document.getElementById('assignments-list');
      const loading = document.getElementById('assignments-loading');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getMyAssignments(Auth.getStudentId(), Auth.getPassword());
        loading.style.display = 'none';

        if (!r.success) { container.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }
        if (r.assignments.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          return;
        }

        let html = '';
        r.assignments.forEach(a => {
          let actionHtml = '';
          if (a.status === 'í‰ê°€ì¤‘') {
            if (a.myEvalStatus === 'completed') {
              actionHtml = '<span class="badge badge-finalized">í‰ê°€ ì™„ë£Œ</span>';
            } else if (a.myEvalStatus === 'pending') {
              actionHtml = `<a href="evaluate.html?id=${a.assignmentId}" class="btn btn-primary btn-sm">í‰ê°€í•˜ê¸°</a>`;
            } else {
              actionHtml = '<span class="badge badge-waiting">ë¯¸ë°°ì •</span>';
            }
          } else if (a.status === 'í™•ì •') {
            actionHtml = `<a href="results.html?id=${a.assignmentId}" class="btn btn-secondary btn-sm">ê²°ê³¼ ë³´ê¸°</a>`;
          }

          html += `
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;">
                <div>
                  <h3 style="font-size:1.05rem;margin-bottom:4px;">${a.name}</h3>
                  <p style="font-size:0.8125rem;color:var(--gray-500);">${a.description || ''}</p>
                </div>
                <div style="text-align:right;">
                  ${getStatusBadge(a.status)}
                </div>
              </div>
              <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div style="font-size:0.8125rem;color:var(--gray-500);">
                  ${a.status === 'í‰ê°€ì¤‘' ? 'í‰ê°€ ë§ˆê°: ' + (a.evalDeadline || '-') : 'ì œì¶œ ë§ˆê°: ' + (a.submitDeadline || '-')}
                </div>
                <div>${actionHtml}</div>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    async function loadResults() {
      const container = document.getElementById('results-list');
      const loading = document.getElementById('results-loading');
      loading.style.display = '';
      container.innerHTML = '';

      try {
        const r = await API.getMyResults(Auth.getStudentId(), Auth.getPassword());
        loading.style.display = 'none';

        if (!r.success) { container.innerHTML = `<div class="alert alert-error">${r.error}</div>`; return; }
        if (r.results.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>í™•ì •ëœ ê²°ê³¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          return;
        }

        let html = '';
        r.results.forEach(res => {
          const avgScore = res.receivedScores.length > 0
            ? (res.receivedScores.reduce((s, e) => s + Number(e.score), 0) / res.receivedScores.length).toFixed(1)
            : '-';

          html += `<div class="card">
            <div class="card-title">${res.assignmentName}</div>

            <h4 style="font-size:0.9rem;color:var(--gray-600);margin-bottom:12px;">ë°›ì€ í‰ê°€ (ìƒí˜¸í‰ê°€ í‰ê· : ${avgScore}ì )</h4>
          `;

          res.receivedScores.forEach((ev, idx) => {
            html += `
              <div class="result-item">
                <div class="score-label">í‰ê°€ ${idx + 1}</div>
                <div class="score-value">${ev.score}ì </div>
                <div class="comment-text">${escapeHtml(ev.comment)}</div>
              </div>
            `;
          });

          if (res.professorScore !== null) {
            html += `
              <div class="result-item professor-eval">
                <div class="score-label">êµìˆ˜ í‰ê°€</div>
                <div class="score-value">${res.professorScore}ì </div>
                <div class="comment-text">${escapeHtml(res.professorComment || '')}</div>
              </div>
            `;
          }

          html += '</div>';
        });
        container.innerHTML = html;
      } catch (err) {
        loading.style.display = 'none';
        container.innerHTML = `<div class="alert alert-error">ì˜¤ë¥˜: ${err.message}</div>`;
      }
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    // ì´ˆê¸° ë¡œë“œ
    loadAssignments();
  </script>
</body>
</html>
